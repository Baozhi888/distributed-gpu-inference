# 地理位置服务 - 生产环境优化说明

## 优化内容

### 1. 内存缓存
- **TTL**: 1小时（3600秒）
- **最大容量**: 10,000条记录
- **自动清理**: 超过容量时自动清理过期记录
- **缓存失败结果**: 避免重复查询失败的IP

### 2. 连接复用
- 使用共享的 `httpx.AsyncClient`
- 连接池配置：
  - 最大连接数: 10
  - 最大保持连接数: 5
- 减少TCP握手开销

### 3. 多API降级
- **主API**: ip-api.com（免费，45次/分钟）
- **备用API**: ipinfo.io（免费，50,000次/月）
- 主API失败自动切换到备用API

### 4. 资源清理
- 应用关闭时自动清理HTTP客户端
- 清空缓存释放内存

## 性能指标

| 指标 | 优化前 | 优化后 |
|------|--------|--------|
| 首次查询延迟 | ~2秒 | ~2秒 |
| 缓存命中延迟 | N/A | <1ms |
| 内存占用 | 每次新建连接 | 复用连接 |
| 失败重试 | 无 | 自动降级 |

## API限制

### ip-api.com
- 免费版: 45次/分钟
- 超限返回: HTTP 429
- 建议: 适合中小规模部署

### ipinfo.io
- 免费版: 50,000次/月
- 超限返回: HTTP 429
- 建议: 作为备用API

## 生产环境建议

### 方案1: 使用当前实现（推荐中小规模）
适用于：
- 日活 < 10,000
- QPS < 10

优点：
- 零成本
- 自动降级
- 缓存优化

### 方案2: 升级到付费API（推荐大规模）
适用于：
- 日活 > 10,000
- QPS > 10

推荐服务：
- **MaxMind GeoIP2**: $50/月起，本地数据库，无限查询
- **ipinfo.io Pro**: $249/月，250,000次/月
- **ip-api.com Pro**: $13/月，无限查询

### 方案3: 自建GeoIP数据库
使用 MaxMind GeoLite2（免费）：

```python
import geoip2.database

reader = geoip2.database.Reader('/path/to/GeoLite2-Country.mmdb')
response = reader.country('8.8.8.8')
country_code = response.country.iso_code
```

优点：
- 完全离线
- 无限查询
- 低延迟（<1ms）

缺点：
- 需要定期更新数据库
- 准确度略低于商业API

## 测试

运行测试：
```bash
cd server
pytest tests/test_geo.py -v
```

## 部署检查清单

- [ ] 确认 `httpx` 已安装
- [ ] 测试API连通性
- [ ] 配置监控告警
- [ ] 设置缓存大小
- [ ] 验证降级策略
- [ ] 压力测试缓存性能
- [ ] 配置日志级别（生产环境建议 INFO）
