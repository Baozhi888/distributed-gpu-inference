# åˆ†å¸ƒå¼GPUæ¨ç†å¹³å°

ä¸€ä¸ªé«˜æ€§èƒ½ã€å®‰å…¨çš„åˆ†å¸ƒå¼GPUæ¨ç†ç³»ç»Ÿï¼Œæ”¯æŒç©ºé—²GPUèµ„æºå…±äº«å’Œå¤§æ¨¡å‹åˆ†å¸ƒå¼æ¨ç†ã€‚

## âœ¨ ç‰¹æ€§

### æ ¸å¿ƒåŠŸèƒ½
- **åˆ†å¸ƒå¼æ¶æ„**: ä¸­å¤®æœåŠ¡å™¨åè°ƒï¼Œå¤šWorkerèŠ‚ç‚¹æ‰§è¡Œ
- **å¤šä»»åŠ¡ç±»å‹**: LLMæ¨ç†ã€å›¾åƒç”Ÿæˆã€è¯­éŸ³è¯†åˆ«ã€æ–‡æœ¬åµŒå…¥
- **æ™ºèƒ½è°ƒåº¦**: åŸºäºå¯é æ€§è¯„åˆ†ã€åŒºåŸŸäº²å’Œæ€§çš„ä»»åŠ¡åˆ†é…
- **å®‰å…¨æœºåˆ¶**: Tokenè½®æ¢ã€è¯·æ±‚ç­¾åã€è´¦æˆ·é”å®šä¿æŠ¤
- **è´Ÿè½½æ§åˆ¶**: Workerå¯è‡ªå®šä¹‰ä»»åŠ¡æ¥å—ç‡ã€å·¥ä½œæ—¶é—´æ®µ
- **ä¼˜é›…ä¸‹çº¿**: æ”¯æŒå®Œæˆå½“å‰ä»»åŠ¡åå®‰å…¨ç¦»çº¿
- **ç›´è¿æ¨¡å¼**: å¯é€‰çš„P2Pç›´è¿é™ä½å»¶è¿Ÿ

### ğŸš€ é«˜æ€§èƒ½æ¨ç†ï¼ˆv2.0 æ–°å¢ï¼‰
- **é«˜æ€§èƒ½åç«¯**: æ”¯æŒ SGLang / vLLM æ¨ç†å¼•æ“ï¼Œæ€§èƒ½æå‡ 5-10x
- **è¿ç»­æ‰¹å¤„ç†**: Continuous Batching åŠ¨æ€åˆå¹¶è¯·æ±‚ï¼Œæé«˜ååé‡
- **å‰ç¼€ç¼“å­˜**: RadixAttention é£æ ¼çš„å‰ç¼€å…±äº«ï¼Œå‡å°‘é‡å¤è®¡ç®—
- **PagedAttention**: é«˜æ•ˆ KV-Cache å†…å­˜ç®¡ç†ï¼Œæ˜¾å­˜åˆ©ç”¨ç‡æå‡ 2-4x

### ğŸŒ åˆ†å¸ƒå¼å¤§æ¨¡å‹ï¼ˆv2.0 æ–°å¢ï¼‰
- **æ¨¡å‹åˆ†ç‰‡**: æ”¯æŒ Llama-70B ç­‰å¤§æ¨¡å‹è·¨å¤šGPUåˆ†å¸ƒå¼æ¨ç†
- **åˆ†å±‚åˆ†å‰²**: æŒ‰ Transformer Block åˆ‡åˆ†åˆ°ä¸åŒèŠ‚ç‚¹
- **è·¨èŠ‚ç‚¹KV-Cache**: æ¯ä¸ªèŠ‚ç‚¹ç»´æŠ¤è‡ªå·±è´Ÿè´£å±‚çš„ KV-Cache
- **å®¹é”™è·¯ç”±**: èŠ‚ç‚¹æ•…éšœè‡ªåŠ¨åˆ‡æ¢ï¼Œæ”¯æŒ KV-Cache é‡å»º

### âš¡ é«˜çº§ä¼˜åŒ–ï¼ˆv2.0 æ–°å¢ï¼‰
- **Prefill/Decodeåˆ†ç¦»**: DistServe æ¶æ„ï¼Œä¼˜åŒ– TTFT å’Œååé‡
- **æ¨æµ‹è§£ç **: EAGLE-3 é£æ ¼æ¨æµ‹è§£ç ï¼Œå•è¯·æ±‚é€Ÿåº¦æå‡ 2-3x
- **åˆ†å±‚ç¼“å­˜**: GPU â†’ CPU â†’ Redis å¤šçº§ KV-Cache
- **å¯è§‚æµ‹æ€§**: Prometheus æŒ‡æ ‡ + OpenTelemetry åˆ†å¸ƒå¼è¿½è¸ª

## æ¶æ„

### æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      å®¢æˆ·ç«¯ (Client)                         â”‚
â”‚                  æäº¤ä»»åŠ¡ / æŸ¥è¯¢ç»“æœ                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ä¸­å¤®æœåŠ¡å™¨ (Server)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ä»»åŠ¡é˜Ÿåˆ—    â”‚  â”‚  æ™ºèƒ½è°ƒåº¦    â”‚  â”‚  å¯é æ€§è¯„åˆ†/å®‰å…¨    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â–¼               â–¼               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Worker 1 â”‚    â”‚ Worker 2 â”‚    â”‚ Worker N â”‚
    â”‚ RTX 4090 â”‚    â”‚ A100     â”‚    â”‚ RTX 3080 â”‚
    â”‚ asia-eastâ”‚    â”‚ eu-west  â”‚    â”‚ us-north â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### v2.0 åˆ†å¸ƒå¼æ¨ç†æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æ§åˆ¶å¹³é¢ (Control Plane)                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  FastAPI    â”‚  â”‚  PostgreSQL â”‚  â”‚  Redis (çŠ¶æ€ + ç¼“å­˜)     â”‚  â”‚
â”‚  â”‚  è°ƒåº¦æœåŠ¡    â”‚  â”‚  å…ƒæ•°æ®å­˜å‚¨  â”‚  â”‚  KV-Cache ç´¢å¼•          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚ æ§åˆ¶ä¿¡ä»¤
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â–¼                   â–¼                   â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Worker 1 â”‚â—„â”€â”€â”€â”€â”€â”€â–ºâ”‚ Worker 2 â”‚â—„â”€â”€â”€â”€â”€â”€â–ºâ”‚ Worker 3 â”‚
    â”‚ Prefill  â”‚  gRPC  â”‚ Decode   â”‚  gRPC  â”‚ Decode   â”‚
    â”‚ A100     â”‚  KVä¼ è¾“ â”‚ RTX 4090 â”‚  æ¿€æ´»å€¼ â”‚ RTX 3090 â”‚
    â”‚ Layer0-26â”‚        â”‚Layer27-53â”‚        â”‚Layer54-79â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          æ•°æ®å¹³é¢ (Data Plane) - Worker é—´ P2P ç›´è¿
```

### Prefill/Decode åˆ†ç¦»æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Prefill/Decode åˆ†ç¦»æ¶æ„                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚   â”‚  Prefill Pool   â”‚         â”‚   Decode Pool   â”‚          â”‚
â”‚   â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚  KVä¼ è¾“  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚          â”‚
â”‚   â”‚  - A100 x 2     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  - RTX 4090 x 4 â”‚          â”‚
â”‚   â”‚  - å¤§æ‰¹é‡å¤„ç†    â”‚         â”‚  - ä½å»¶è¿Ÿè§£ç     â”‚          â”‚
â”‚   â”‚  - è®¡ç®—å¯†é›†     â”‚         â”‚  - å†…å­˜å¯†é›†     â”‚          â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                             â”‚
â”‚   ç‰¹ç‚¹ï¼š                                                     â”‚
â”‚   - Prefill: é«˜å¹¶è¡Œåº¦ï¼Œå……åˆ†åˆ©ç”¨ Tensor Core               â”‚
â”‚   - Decode:  ä½å»¶è¿Ÿï¼Œå……åˆ†åˆ©ç”¨æ˜¾å­˜å¸¦å®½                       â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## å¿«é€Ÿå¼€å§‹

### æœåŠ¡å™¨éƒ¨ç½²

```bash
cd server

# å®‰è£…ä¾èµ–
pip install -r requirements.txt

# é…ç½®ç¯å¢ƒå˜é‡
cp .env.example .env
# ç¼–è¾‘ .env è®¾ç½®æ•°æ®åº“è¿æ¥ç­‰

# åˆå§‹åŒ–æ•°æ®åº“
alembic upgrade head

# å¯åŠ¨æœåŠ¡å™¨
uvicorn app.main:app --host 0.0.0.0 --port 8000
```

### WorkerèŠ‚ç‚¹å®‰è£…

#### æ–¹å¼1: ä½¿ç”¨ npxï¼ˆæ¨èï¼‰

æœ€ç®€å•çš„å®‰è£…æ–¹å¼ï¼Œè‡ªåŠ¨ç®¡ç† Python è™šæ‹Ÿç¯å¢ƒï¼š

```bash
# ä¸€é”®å¯åŠ¨äº¤äº’å¼èœå•
npx gpu-worker

# æˆ–è€…åˆ†æ­¥æ‰§è¡Œ
npx gpu-worker setup       # åˆå§‹åŒ–ç¯å¢ƒï¼ˆé¦–æ¬¡è¿è¡Œè‡ªåŠ¨æ‰§è¡Œï¼‰
npx gpu-worker configure   # äº¤äº’å¼é…ç½®å‘å¯¼
npx gpu-worker start       # å¯åŠ¨ Worker
npx gpu-worker status      # æŸ¥çœ‹çŠ¶æ€
```

**å·¥ä½œåŸç†ï¼š**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     npx gpu-worker / npm install -g gpu-worker          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  bin/gpu-worker.js (Node.js CLI å…¥å£)                   â”‚
â”‚  â”œâ”€ æ£€æµ‹ç³»ç»Ÿ Python 3.9+                                â”‚
â”‚  â”œâ”€ è‡ªåŠ¨åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ (.venv)                            â”‚
â”‚  â””â”€ è‡ªåŠ¨å®‰è£… Python ä¾èµ– (PyTorch, Transformersç­‰)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  cli.py (Python CLI)                                    â”‚
â”‚  â”œâ”€ äº¤äº’å¼é…ç½®å‘å¯¼ (æœåŠ¡å™¨ã€åŒºåŸŸã€GPUã€ä»»åŠ¡ç±»å‹)         â”‚
â”‚  â””â”€ å¯åŠ¨ Worker ä¸»ç¨‹åº                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¼˜ç‚¹ï¼š**
- æ— éœ€æ‰‹åŠ¨ç®¡ç† Python è™šæ‹Ÿç¯å¢ƒ
- é¦–æ¬¡è¿è¡Œè‡ªåŠ¨å®‰è£…æ‰€æœ‰ä¾èµ–
- ä¾èµ–éš”ç¦»ï¼Œä¸æ±¡æŸ“ç³»ç»Ÿç¯å¢ƒ
- è·¨å¹³å°æ”¯æŒ (Windows/macOS/Linux)

#### æ–¹å¼2: å…¨å±€å®‰è£… npm åŒ…

```bash
# å…¨å±€å®‰è£…
npm install -g gpu-worker

# ä½¿ç”¨
gpu-worker              # äº¤äº’å¼èœå•
gpu-worker configure    # é…ç½®
gpu-worker start        # å¯åŠ¨
gpu-worker status       # çŠ¶æ€
gpu-worker set <key> <value>  # è®¾ç½®é…ç½®é¡¹
```

#### æ–¹å¼3: pip å®‰è£…

```bash
cd worker

pip install -e .
gpu-worker configure
gpu-worker start
```

#### æ–¹å¼4: ç›´æ¥è¿è¡Œ Python

```bash
cd worker

pip install -r requirements.txt
python cli.py configure
python cli.py start
```

### ç¯å¢ƒè¦æ±‚

| å®‰è£…æ–¹å¼ | è¦æ±‚ |
|---------|------|
| npx / npm | Node.js 16+, Python 3.9+ (è‡ªåŠ¨æ£€æµ‹) |
| pip | Python 3.9+ |
| ç›´æ¥è¿è¡Œ | Python 3.9+ |

**æ³¨æ„**: æ‰€æœ‰æ–¹å¼éƒ½éœ€è¦ç³»ç»Ÿå·²å®‰è£… Python 3.9+ï¼Œnpm æ–¹å¼ä¼šè‡ªåŠ¨æ£€æµ‹å¹¶æç¤ºå®‰è£…ã€‚

## Worker CLI å‘½ä»¤

```bash
# å®‰è£…ä¾èµ–
gpu-worker install

# äº¤äº’å¼é…ç½®å‘å¯¼
gpu-worker configure

# å¯åŠ¨Worker
gpu-worker start

# æŸ¥çœ‹çŠ¶æ€
gpu-worker status

# è®¾ç½®å•ä¸ªé…ç½®é¡¹
gpu-worker set load_control.acceptance_rate 0.8
gpu-worker set load_control.working_hours_start 9
gpu-worker set load_control.working_hours_end 22
```

## ç¯å¢ƒé…ç½®

Worker æ”¯æŒä¸‰ç§é…ç½®æ–¹å¼ï¼ˆä¼˜å…ˆçº§ä»é«˜åˆ°ä½ï¼‰ï¼š

1. **ç¯å¢ƒå˜é‡** - é€‚åˆå®¹å™¨åŒ–éƒ¨ç½²
2. **config.yaml** - é€‚åˆæœ¬åœ°å¼€å‘
3. **é»˜è®¤å€¼** - è‡ªåŠ¨æ£€æµ‹

### æ–¹å¼1: ä½¿ç”¨ .env æ–‡ä»¶

```bash
# å¤åˆ¶ç¤ºä¾‹é…ç½®
cp .env.example .env

# ç¼–è¾‘é…ç½®
nano .env
```

**.env æ–‡ä»¶ç¤ºä¾‹ï¼š**

```bash
# æœåŠ¡å™¨è¿æ¥ï¼ˆå¿…å¡«ï¼‰
GPU_SERVER_URL=https://gpu-inference.example.com
GPU_SERVER_TIMEOUT=30
GPU_SERVER_VERIFY_SSL=true

# åœ°ç†ä½ç½®ï¼ˆå½±å“ä»»åŠ¡è°ƒåº¦ï¼‰
GPU_REGION=asia-east
GPU_COUNTRY=China
GPU_CITY=Shanghai

# Workeråç§°
GPU_WORKER_NAME=My-RTX4090-Worker

# æ”¯æŒçš„ä»»åŠ¡ç±»å‹
GPU_SUPPORTED_TYPES=llm,image_gen

# æ¨¡å‹é…ç½®
GPU_LLM_MODEL=Qwen/Qwen2.5-7B-Instruct
GPU_IMAGE_MODEL=black-forest-labs/FLUX.1-schnell

# è´Ÿè½½æ§åˆ¶
GPU_ACCEPTANCE_RATE=1.0
GPU_MAX_CONCURRENT_JOBS=1
GPU_WORKING_HOURS_START=9
GPU_WORKING_HOURS_END=22

# HuggingFaceé•œåƒï¼ˆä¸­å›½ç”¨æˆ·æ¨èï¼‰
HF_ENDPOINT=https://hf-mirror.com
```

### æ–¹å¼2: ä½¿ç”¨ config.yaml

```bash
# å¤åˆ¶ç¤ºä¾‹é…ç½®
cp config.example.yaml config.yaml

# ç¼–è¾‘é…ç½®
nano config.yaml
```

### æ–¹å¼3: é€šè¿‡äº¤äº’å¼å‘å¯¼

```bash
gpu-worker configure
```

å‘å¯¼ä¼šå¼•å¯¼ä½ å®Œæˆæ‰€æœ‰é…ç½®é¡¹çš„è®¾ç½®ã€‚

### ç¯å¢ƒå˜é‡å‚è€ƒ

| ç¯å¢ƒå˜é‡ | è¯´æ˜ | é»˜è®¤å€¼ |
|---------|------|--------|
| `GPU_SERVER_URL` | æœåŠ¡å™¨åœ°å€ | `http://localhost:8000` |
| `GPU_SERVER_TIMEOUT` | è¿æ¥è¶…æ—¶(ç§’) | `30` |
| `GPU_SERVER_VERIFY_SSL` | éªŒè¯SSLè¯ä¹¦ | `true` |
| `GPU_REGION` | åŒºåŸŸä»£ç  | `asia-east` |
| `GPU_WORKER_NAME` | Workeråç§° | è‡ªåŠ¨ç”Ÿæˆ |
| `GPU_SUPPORTED_TYPES` | æ”¯æŒçš„ä»»åŠ¡ç±»å‹ | `llm,image_gen` |
| `GPU_DEVICE_ID` | GPUè®¾å¤‡ID | `0` |
| `GPU_ENABLE_CPU_OFFLOAD` | å¯ç”¨CPU Offload | `true` |
| `GPU_ACCEPTANCE_RATE` | ä»»åŠ¡æ¥å—ç‡ | `1.0` |
| `GPU_MAX_CONCURRENT_JOBS` | æœ€å¤§å¹¶å‘ä»»åŠ¡ | `1` |
| `GPU_DIRECT_ENABLED` | å¯ç”¨ç›´è¿ | `false` |
| `GPU_HEARTBEAT_INTERVAL` | å¿ƒè·³é—´éš”(ç§’) | `30` |

## æœåŠ¡å™¨è¿æ¥æµç¨‹

Worker è¿æ¥åˆ°ä¸­å¤®æœåŠ¡å™¨çš„å®Œæ•´æµç¨‹ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Worker å¯åŠ¨                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. åŠ è½½é…ç½®                                                     â”‚
â”‚     â”œâ”€ è¯»å– .env æ–‡ä»¶                                            â”‚
â”‚     â”œâ”€ è¯»å– config.yaml                                          â”‚
â”‚     â””â”€ åº”ç”¨ç¯å¢ƒå˜é‡è¦†ç›–                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. æ³¨å†Œåˆ°æœåŠ¡å™¨                                                  â”‚
â”‚     POST /api/v1/workers/register                                â”‚
â”‚     â”œâ”€ å‘é€: GPUä¿¡æ¯ã€åŒºåŸŸã€æ”¯æŒçš„ä»»åŠ¡ç±»å‹                         â”‚
â”‚     â””â”€ è¿”å›: worker_id, token, refresh_token, signing_secret     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. è·å–è¿œç¨‹é…ç½®                                                  â”‚
â”‚     GET /api/v1/workers/{id}/config                              â”‚
â”‚     â””â”€ è¿”å›: æœåŠ¡ç«¯ä¸‹å‘çš„è´Ÿè½½æ§åˆ¶ã€æ¨¡å‹é…ç½®ç­‰                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. åŠ è½½æ¨ç†å¼•æ“                                                  â”‚
â”‚     â”œâ”€ æ ¹æ® supported_types åŠ è½½å¯¹åº”å¼•æ“                          â”‚
â”‚     â””â”€ ä¸‹è½½/åŠ è½½æ¨¡å‹åˆ°GPU                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5. å¼€å§‹å·¥ä½œå¾ªç¯                                                  â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚     â”‚  å¿ƒè·³çº¿ç¨‹ (æ¯30ç§’)                                     â”‚    â”‚
â”‚     â”‚  POST /api/v1/workers/{id}/heartbeat                  â”‚    â”‚
â”‚     â”‚  â”œâ”€ å‘é€: çŠ¶æ€ã€GPUä½¿ç”¨ç‡ã€é…ç½®ç‰ˆæœ¬                     â”‚    â”‚
â”‚     â”‚  â””â”€ è¿”å›: æœåŠ¡å™¨æŒ‡ä»¤ã€é…ç½®å˜æ›´é€šçŸ¥                      â”‚    â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚     â”‚  ä»»åŠ¡å¾ªç¯ (æ¯2ç§’)                                      â”‚    â”‚
â”‚     â”‚  GET /api/v1/workers/{id}/next-job                    â”‚    â”‚
â”‚     â”‚  â”œâ”€ è·å–ä»»åŠ¡ â†’ æ‰§è¡Œæ¨ç† â†’ è¿”å›ç»“æœ                      â”‚    â”‚
â”‚     â”‚  â””â”€ POST /api/v1/workers/{id}/jobs/{job_id}/complete  â”‚    â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è¿æ¥è®¤è¯

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Worker    â”‚                      â”‚    Server    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                                     â”‚
       â”‚  1. æ³¨å†Œè¯·æ±‚ (GPUä¿¡æ¯)               â”‚
       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
       â”‚                                     â”‚
       â”‚  2. è¿”å› token + refresh_token      â”‚
       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
       â”‚                                     â”‚
       â”‚  3. åç»­è¯·æ±‚æºå¸¦ X-Worker-Token     â”‚
       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
       â”‚                                     â”‚
       â”‚  4. Tokenè¿‡æœŸå‰è‡ªåŠ¨åˆ·æ–°              â”‚
       â”‚  POST /refresh-token               â”‚
       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
       â”‚                                     â”‚
       â”‚  5. è¿”å›æ–° token                    â”‚
       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
       â”‚                                     â”‚
```

### é…ç½®åŒæ­¥æœºåˆ¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Worker    â”‚                      â”‚    Server    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                                     â”‚
       â”‚  å¿ƒè·³: config_version=1             â”‚
       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
       â”‚                                     â”‚
       â”‚  å“åº”: config_changed=true          â”‚
       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
       â”‚                                     â”‚
       â”‚  è·å–æ–°é…ç½®                          â”‚
       â”‚  GET /config                        â”‚
       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
       â”‚                                     â”‚
       â”‚  è¿”å›: version=2, load_control...   â”‚
       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
       â”‚                                     â”‚
       â”‚  åº”ç”¨æ–°çš„è´Ÿè½½æ§åˆ¶é…ç½®                 â”‚
       â”‚                                     â”‚
```

## é…ç½®è¯´æ˜

### Workeré…ç½® (config.yaml)

```yaml
# æœåŠ¡å™¨è¿æ¥
server:
  url: https://gpu-inference.example.com
  timeout: 30
  verify_ssl: true

# åŒºåŸŸè®¾ç½®
region: asia-east

# GPUé…ç½®
gpu:
  model: NVIDIA GeForce RTX 4090
  memory_gb: 24
  count: 1
  enable_cpu_offload: false

# æ”¯æŒçš„ä»»åŠ¡ç±»å‹
supported_types:
  - llm
  - image_gen

# è´Ÿè½½æ§åˆ¶
load_control:
  acceptance_rate: 1.0        # ä»»åŠ¡æ¥å—ç‡ (0.1-1.0)
  max_concurrent_jobs: 1      # æœ€å¤§å¹¶å‘ä»»åŠ¡æ•°
  max_jobs_per_hour: 0        # æ¯å°æ—¶æœ€å¤§ä»»åŠ¡æ•° (0=ä¸é™)
  working_hours_start: 9      # å·¥ä½œå¼€å§‹æ—¶é—´ (å¯é€‰)
  working_hours_end: 22       # å·¥ä½œç»“æŸæ—¶é—´ (å¯é€‰)

# ç›´è¿é…ç½® (å¯é€‰)
direct:
  enabled: false
  host: 0.0.0.0
  port: 8080
  public_url: null            # å…¬ç½‘å¯è®¿é—®åœ°å€
```

### åŒºåŸŸä»£ç 

| ä»£ç  | æè¿° |
|------|------|
| `asia-east` | ä¸œäºšï¼ˆä¸­å›½ã€æ—¥æœ¬ã€éŸ©å›½ï¼‰ |
| `asia-south` | ä¸œå—äºšï¼ˆæ–°åŠ å¡ã€æ³°å›½ï¼‰ |
| `europe-west` | è¥¿æ¬§ï¼ˆå¾·å›½ã€æ³•å›½ã€è‹±å›½ï¼‰ |
| `europe-east` | ä¸œæ¬§ |
| `america-north` | åŒ—ç¾ï¼ˆç¾å›½ã€åŠ æ‹¿å¤§ï¼‰ |
| `america-south` | å—ç¾ |
| `oceania` | å¤§æ´‹æ´²ï¼ˆæ¾³å¤§åˆ©äºšï¼‰ |

## APIæ–‡æ¡£

### å®¢æˆ·ç«¯API

#### æäº¤ä»»åŠ¡

```http
POST /api/v1/jobs
Content-Type: application/json
X-API-Key: your-api-key

{
  "type": "llm",
  "params": {
    "model": "Qwen/Qwen2.5-7B-Instruct",
    "messages": [{"role": "user", "content": "Hello!"}],
    "max_tokens": 512
  },
  "preferred_region": "asia-east",
  "priority": 0
}
```

#### æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€

```http
GET /api/v1/jobs/{job_id}
X-API-Key: your-api-key
```

#### è·å–é˜Ÿåˆ—çŠ¶æ€

```http
GET /api/v1/queue/stats?region=asia-east
X-API-Key: your-api-key
```

### Worker API

#### æ³¨å†ŒWorker

```http
POST /api/v1/workers/register

{
  "name": "My GPU Worker",
  "region": "asia-east",
  "gpu_model": "NVIDIA GeForce RTX 4090",
  "gpu_memory_gb": 24,
  "supported_types": ["llm", "image_gen"]
}
```

å“åº”:
```json
{
  "worker_id": "uuid",
  "token": "access_token",
  "refresh_token": "refresh_token",
  "signing_secret": "secret_for_signing",
  "token_expires_at": "2024-01-02T00:00:00Z"
}
```

#### å¿ƒè·³

```http
POST /api/v1/workers/{worker_id}/heartbeat
X-Worker-Token: your-token

{
  "status": "online",
  "gpu_memory_used_gb": 8.5,
  "config_version": 1
}
```

#### è·å–è¿œç¨‹é…ç½®

```http
GET /api/v1/workers/{worker_id}/config
X-Worker-Token: your-token
```

#### æ›´æ–°é…ç½®

```http
PUT /api/v1/workers/{worker_id}/config
X-Worker-Token: your-token

{
  "acceptance_rate": 0.8,
  "working_hours_start": 9,
  "working_hours_end": 22
}
```

#### åˆ·æ–°Token

```http
POST /api/v1/workers/{worker_id}/refresh-token

{
  "refresh_token": "your-refresh-token"
}
```

## å®‰å…¨æœºåˆ¶

### Tokenç®¡ç†

- Access Tokenæœ‰æ•ˆæœŸ: 24å°æ—¶
- Refresh Tokenæ”¯æŒæ— æ„Ÿåˆ·æ–°
- æå‰4å°æ—¶è‡ªåŠ¨åˆ·æ–°Token

### è¯·æ±‚ç­¾å

å…³é”®è¯·æ±‚ä½¿ç”¨HMAC-SHA256ç­¾åï¼š

```
ç­¾åå†…å®¹ = METHOD:PATH:BODY_HASH:TIMESTAMP
ç­¾å = HMAC-SHA256(signing_secret, ç­¾åå†…å®¹)
```

è¯·æ±‚å¤´:
```
X-Signature: <signature>
X-Timestamp: <unix_timestamp>
```

### è´¦æˆ·é”å®š

- è¿ç»­5æ¬¡è®¤è¯å¤±è´¥åé”å®š
- é”å®šæ—¶é—´: 15åˆ†é’Ÿ
- è‡ªåŠ¨è§£é”æˆ–ç®¡ç†å‘˜æ‰‹åŠ¨è§£é”

## ä»»åŠ¡ç±»å‹

### LLMæ¨ç†

```json
{
  "type": "llm",
  "params": {
    "model": "Qwen/Qwen2.5-7B-Instruct",
    "messages": [{"role": "user", "content": "Hello"}],
    "max_tokens": 512,
    "temperature": 0.7,
    "stream": false
  }
}
```

### å›¾åƒç”Ÿæˆ

```json
{
  "type": "image_gen",
  "params": {
    "model": "stabilityai/stable-diffusion-xl-base-1.0",
    "prompt": "A beautiful sunset over mountains",
    "negative_prompt": "blurry, low quality",
    "width": 1024,
    "height": 1024,
    "num_inference_steps": 30
  }
}
```

### è¯­éŸ³è¯†åˆ«

```json
{
  "type": "whisper",
  "params": {
    "model": "openai/whisper-large-v3",
    "audio_url": "https://example.com/audio.mp3",
    "language": "zh"
  }
}
```

### æ–‡æœ¬åµŒå…¥

```json
{
  "type": "embedding",
  "params": {
    "model": "BAAI/bge-large-zh-v1.5",
    "texts": ["æ–‡æœ¬1", "æ–‡æœ¬2"]
  }
}
```

## å¯é æ€§è¯„åˆ†

Workerå¯é æ€§è¯„åˆ†åŸºäºä»¥ä¸‹å› ç´ è®¡ç®—ï¼š

| å› ç´  | æƒé‡ | è¯´æ˜ |
|------|------|------|
| ä»»åŠ¡æˆåŠŸç‡ | 40% | æˆåŠŸå®Œæˆçš„ä»»åŠ¡æ¯”ä¾‹ |
| åœ¨çº¿ç¨³å®šæ€§ | 30% | å¹³å‡ä¼šè¯æ—¶é•¿ã€æ„å¤–ç¦»çº¿æ¬¡æ•° |
| å“åº”å»¶è¿Ÿ | 20% | å¹³å‡ä»»åŠ¡å¤„ç†æ—¶é—´ |
| å†å²è¡¨ç° | 10% | é•¿æœŸç´¯è®¡è¡¨ç° |

è¯„åˆ†èŒƒå›´: 0.0 - 1.0

## ç›®å½•ç»“æ„

```
distributed-gpu-inference/
â”œâ”€â”€ server/                         # ä¸­å¤®æœåŠ¡å™¨
â”‚   â”œâ”€â”€ app/
â”‚   â”‚   â”œâ”€â”€ api/                    # APIè·¯ç”±
â”‚   â”‚   â”‚   â”œâ”€â”€ jobs.py             # ä»»åŠ¡API
â”‚   â”‚   â”‚   â”œâ”€â”€ workers.py          # Worker API
â”‚   â”‚   â”‚   â””â”€â”€ admin.py            # ç®¡ç†API
â”‚   â”‚   â”œâ”€â”€ db/                     # æ•°æ®åº“
â”‚   â”‚   â”œâ”€â”€ models/                 # æ•°æ®æ¨¡å‹
â”‚   â”‚   â””â”€â”€ services/               # ä¸šåŠ¡é€»è¾‘
â”‚   â”‚       â”œâ”€â”€ scheduler.py        # æ™ºèƒ½è°ƒåº¦
â”‚   â”‚       â”œâ”€â”€ pd_scheduler.py     # Prefill/Decode åˆ†ç¦»è°ƒåº¦ (v2.0)
â”‚   â”‚       â”œâ”€â”€ reliability.py      # å¯é æ€§è¯„åˆ†
â”‚   â”‚       â”œâ”€â”€ security.py         # å®‰å…¨æœåŠ¡
â”‚   â”‚       â”œâ”€â”€ observability.py    # ç›‘æ§è¿½è¸ª (v2.0)
â”‚   â”‚       â””â”€â”€ worker_config.py    # é…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ requirements.txt
â”‚   â””â”€â”€ main.py
â”‚
â”œâ”€â”€ worker/                         # GPU Worker
â”‚   â”œâ”€â”€ package.json                # npm åŒ…é…ç½®
â”‚   â”œâ”€â”€ bin/
â”‚   â”‚   â””â”€â”€ gpu-worker.js           # Node.js CLI å…¥å£
â”‚   â”œâ”€â”€ scripts/
â”‚   â”‚   â””â”€â”€ postinstall.js          # npm å®‰è£…åè„šæœ¬
â”‚   â”œâ”€â”€ .env.example                # ç¯å¢ƒå˜é‡ç¤ºä¾‹
â”‚   â”œâ”€â”€ config.example.yaml         # YAMLé…ç½®ç¤ºä¾‹
â”‚   â”œâ”€â”€ cli.py                      # Python CLI
â”‚   â”œâ”€â”€ main.py                     # Worker ä¸»ç¨‹åº
â”‚   â”œâ”€â”€ api_client.py               # API å®¢æˆ·ç«¯
â”‚   â”œâ”€â”€ config.py                   # é…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ batch_processor.py          # è¿ç»­æ‰¹å¤„ç†å™¨ (v2.0)
â”‚   â”œâ”€â”€ engines/                    # æ¨ç†å¼•æ“
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ base.py                 # å¼•æ“åŸºç±»
â”‚   â”‚   â”œâ”€â”€ llm.py                  # åŸç”Ÿ Transformers æ¨ç†
â”‚   â”‚   â”œâ”€â”€ llm_sglang.py           # SGLang é«˜æ€§èƒ½æ¨ç† (v2.0)
â”‚   â”‚   â”œâ”€â”€ llm_vllm.py             # vLLM é«˜æ€§èƒ½æ¨ç† (v2.0)
â”‚   â”‚   â”œâ”€â”€ speculative.py          # EAGLE-3 æ¨æµ‹è§£ç  (v2.0)
â”‚   â”‚   â”œâ”€â”€ image_gen.py            # å›¾åƒç”Ÿæˆ
â”‚   â”‚   â””â”€â”€ vision.py               # è§†è§‰æ¨¡å‹
â”‚   â”œâ”€â”€ distributed/                # åˆ†å¸ƒå¼æ¨ç†ç»„ä»¶ (v2.0)
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ session.py              # åˆ†å¸ƒå¼æ¨ç†ä¼šè¯
â”‚   â”‚   â”œâ”€â”€ model_shard.py          # æ¨¡å‹åˆ†ç‰‡åŠ è½½
â”‚   â”‚   â”œâ”€â”€ kv_cache.py             # KV-Cache åˆ†å¸ƒå¼ç®¡ç†
â”‚   â”‚   â””â”€â”€ grpc_server.py          # gRPC P2P é€šä¿¡
â”‚   â”œâ”€â”€ direct_server.py            # ç›´è¿æœåŠ¡å™¨
â”‚   â”œâ”€â”€ Dockerfile                  # Dockeré•œåƒ
â”‚   â”œâ”€â”€ setup.py                    # pip å®‰è£…é…ç½®
â”‚   â””â”€â”€ requirements.txt
â”‚
â”œâ”€â”€ common/                         # å…±äº«ç»„ä»¶ (v2.0)
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ data_structures.py          # æ ¸å¿ƒæ•°æ®ç»“æ„
â”‚   â””â”€â”€ serialization.py            # Tensor åºåˆ—åŒ–
â”‚
â”œâ”€â”€ proto/                          # gRPC åè®®å®šä¹‰ (v2.0)
â”‚   â””â”€â”€ inference.proto             # åˆ†å¸ƒå¼æ¨ç†åè®®
â”‚
â”œâ”€â”€ sdk/                            # å®¢æˆ·ç«¯SDK
â”‚   â””â”€â”€ python/
â”‚       â””â”€â”€ inference_client.py     # Python å®¢æˆ·ç«¯
â”‚
â”œâ”€â”€ docs/                           # æ–‡æ¡£
â”‚   â””â”€â”€ API_AND_DEPLOYMENT_GUIDE.md # APIä¸éƒ¨ç½²æŒ‡å—
â”‚
â”œâ”€â”€ docker-compose.yml              # Docker Compose é…ç½®
â”œâ”€â”€ REFACTORING_PLAN.md             # é‡æ„è®¡åˆ’æ–‡æ¡£
â”œâ”€â”€ PROJECT_PLAN.md                 # é¡¹ç›®è®¡åˆ’
â””â”€â”€ README.md
```

## ç¯å¢ƒè¦æ±‚

### æœåŠ¡å™¨

- Python 3.9+
- PostgreSQL 13+
- Redis (å¯é€‰ï¼Œç”¨äºç¼“å­˜)

### Worker

- Python 3.9+
- CUDA 11.8+ (GPUæ¨ç†)
- 8GB+ GPUæ˜¾å­˜ (æ¨è16GB+)

## å¸¸è§é—®é¢˜

### Q: Workeræ— æ³•è¿æ¥æœåŠ¡å™¨ï¼Ÿ

æ£€æŸ¥:
1. æœåŠ¡å™¨URLæ˜¯å¦æ­£ç¡®
2. ç½‘ç»œé˜²ç«å¢™æ˜¯å¦å…è®¸å‡ºç«™è¿æ¥
3. SSLè¯ä¹¦æ˜¯å¦æœ‰æ•ˆ

### Q: Tokenè¿‡æœŸæ€ä¹ˆåŠï¼Ÿ

Workerä¼šè‡ªåŠ¨åˆ·æ–°Tokenã€‚å¦‚æœåˆ·æ–°å¤±è´¥:
```bash
# é‡æ–°é…ç½®
gpu-worker configure
```

### Q: å¦‚ä½•é™åˆ¶GPUä½¿ç”¨ï¼Ÿ

åœ¨é…ç½®ä¸­è®¾ç½®:
```yaml
load_control:
  max_gpu_memory_percent: 80  # æœ€å¤§ä½¿ç”¨80%æ˜¾å­˜
  max_concurrent_jobs: 1      # åŒæ—¶åªå¤„ç†1ä¸ªä»»åŠ¡
```

### Q: æ”¯æŒå¤šGPUå—ï¼Ÿ

ç›®å‰å•Workeræ”¯æŒå•GPUã€‚å¤šGPUå»ºè®®:
1. è¿è¡Œå¤šä¸ªWorkerå®ä¾‹
2. æ¯ä¸ªWorkerç»‘å®šä¸åŒGPU
3. **v2.0**: ä½¿ç”¨åˆ†å¸ƒå¼æ¨¡å‹åˆ†ç‰‡ï¼Œè·¨å¤šGPUè¿è¡Œå¤§æ¨¡å‹

## é«˜çº§é…ç½® (v2.0)

### é«˜æ€§èƒ½æ¨ç†åç«¯

é€‰æ‹©æ¨ç†åç«¯ï¼ˆåœ¨ config.yaml ä¸­é…ç½®ï¼‰ï¼š

```yaml
# æ¨ç†å¼•æ“é…ç½®
inference:
  # å¼•æ“ç±»å‹: llm | llm_sglang | llm_vllm | llm_vllm_async
  engine: llm_sglang

  # SGLang é…ç½®
  sglang:
    mem_fraction_static: 0.8      # GPU å†…å­˜å ç”¨æ¯”ä¾‹
    chunked_prefill_size: 8192    # åˆ†å—é¢„å¡«å……å¤§å°

  # vLLM é…ç½®
  vllm:
    gpu_memory_utilization: 0.85  # GPU å†…å­˜åˆ©ç”¨ç‡
    max_num_seqs: 256             # æœ€å¤§å¹¶å‘åºåˆ—æ•°

  # æ‰¹å¤„ç†é…ç½®
  batch:
    max_batch_size: 32            # æœ€å¤§æ‰¹å¤§å°
    max_wait_ms: 50               # æœ€å¤§ç­‰å¾…æ—¶é—´
```

### å®‰è£…é«˜æ€§èƒ½åç«¯

```bash
# å®‰è£… SGLang (æ¨è)
pip install sglang[all]

# æˆ–å®‰è£… vLLM
pip install vllm
```

### åˆ†å¸ƒå¼æ¨¡å‹é…ç½®

è·¨å¤šGPUè¿è¡Œå¤§æ¨¡å‹ï¼ˆå¦‚ Llama-2-70bï¼‰ï¼š

```yaml
distributed:
  enabled: true
  role: hybrid                    # prefill | decode | hybrid

  # æ¨¡å‹åˆ†ç‰‡é…ç½®
  model_shard:
    model_id: meta-llama/Llama-2-70b-chat-hf
    start_layer: 0                # è´Ÿè´£çš„èµ·å§‹å±‚
    end_layer: 27                 # è´Ÿè´£çš„ç»“æŸå±‚

  # P2P é€šä¿¡é…ç½®
  grpc:
    host: 0.0.0.0
    port: 50051

  # KV-Cache é…ç½®
  kv_cache:
    gpu_cache_size_gb: 4.0        # GPU ç¼“å­˜å¤§å°
    cpu_cache_size_gb: 16.0       # CPU ç¼“å­˜å¤§å°
    enable_redis: true            # å¯ç”¨ Redis è¿œç¨‹ç¼“å­˜
    redis_url: redis://localhost:6379
```

### æ¨æµ‹è§£ç é…ç½®

å¯ç”¨ EAGLE-3 é£æ ¼æ¨æµ‹è§£ç æå‡å•è¯·æ±‚é€Ÿåº¦ï¼š

```yaml
speculative:
  enabled: true
  num_speculative_tokens: 5       # æ¯æ­¥æ¨æµ‹ token æ•°
  tree_width: 3                   # å€™é€‰æ ‘å®½åº¦
  tree_depth: 5                   # å€™é€‰æ ‘æ·±åº¦
  adaptive_depth: true            # è‡ªé€‚åº”è°ƒæ•´æ·±åº¦
  min_accept_rate: 0.3            # æœ€å°æ¥å—ç‡é˜ˆå€¼
```

### ç›‘æ§é…ç½®

å¯ç”¨ Prometheus æŒ‡æ ‡å’Œ OpenTelemetry è¿½è¸ªï¼š

```yaml
observability:
  # Prometheus æŒ‡æ ‡
  metrics:
    enabled: true
    port: 9090

  # OpenTelemetry è¿½è¸ª
  tracing:
    enabled: true
    exporter: otlp                # otlp | jaeger | zipkin
    endpoint: http://localhost:4317
    sample_rate: 1.0
```

## æŠ€æœ¯å‚è€ƒ

### æ ¸å¿ƒæŠ€æœ¯

| æŠ€æœ¯ | ç”¨é€” | å‚è€ƒ |
|------|------|------|
| **SGLang** | é«˜æ€§èƒ½æ¨ç†åç«¯ | [github.com/sgl-project/sglang](https://github.com/sgl-project/sglang) |
| **vLLM** | æ¨ç†å¼•æ“ | [github.com/vllm-project/vllm](https://github.com/vllm-project/vllm) |
| **PagedAttention** | KV-Cache å†…å­˜ç®¡ç† | [arXiv:2309.06180](https://arxiv.org/abs/2309.06180) |
| **DistServe** | Prefill/Decode åˆ†ç¦» | [Hao AI Lab](https://hao-ai-lab.github.io/blogs/distserve/) |
| **EAGLE-3** | æ¨æµ‹è§£ç  | [arXiv:2503.01840](https://arxiv.org/abs/2503.01840) |
| **Petals** | åˆ†å¸ƒå¼æ¨ç†å‚è€ƒ | [github.com/bigscience-workshop/petals](https://github.com/bigscience-workshop/petals) |

## å¼€å‘

### è¿è¡Œæµ‹è¯•

```bash
# æœåŠ¡å™¨æµ‹è¯•
cd server
pytest

# Workeræµ‹è¯•
cd worker
pytest
```

### ä»£ç é£æ ¼

```bash
# æ ¼å¼åŒ–
black .
isort .

# ç±»å‹æ£€æŸ¥
mypy .
```

## è®¸å¯è¯

MIT License

## æ›´æ–°æ—¥å¿—

### v2.0.0 (2025-12)

**ğŸš€ é«˜æ€§èƒ½æ¨ç†**
- æ–°å¢ SGLang æ¨ç†å¼•æ“ (`worker/engines/llm_sglang.py`)
- æ–°å¢ vLLM æ¨ç†å¼•æ“ (`worker/engines/llm_vllm.py`)
- å®ç°è¿ç»­æ‰¹å¤„ç† (`worker/batch_processor.py`)
- æ”¯æŒ RadixAttention å‰ç¼€ç¼“å­˜

**ğŸŒ åˆ†å¸ƒå¼å¤§æ¨¡å‹**
- å®ç°æ¨¡å‹åˆ†ç‰‡åŠ è½½ (`worker/distributed/model_shard.py`)
- å®ç°åˆ†å¸ƒå¼æ¨ç†ä¼šè¯ (`worker/distributed/session.py`)
- æ·»åŠ  gRPC P2P é€šä¿¡ (`worker/distributed/grpc_server.py`)
- æ”¯æŒ Llama-70B ç­‰å¤§æ¨¡å‹è·¨GPUæ¨ç†

**âš¡ é«˜çº§ä¼˜åŒ–**
- å®ç° Prefill/Decode åˆ†ç¦»è°ƒåº¦ (`server/app/services/pd_scheduler.py`)
- æ·»åŠ  PagedAttention KV-Cache ç®¡ç† (`worker/distributed/kv_cache.py`)
- é›†æˆ EAGLE-3 æ¨æµ‹è§£ç  (`worker/engines/speculative.py`)
- æ”¯æŒ GPUâ†’CPUâ†’Redis å¤šçº§ç¼“å­˜

**ğŸ“Š å¯è§‚æµ‹æ€§**
- é›†æˆ Prometheus æŒ‡æ ‡å¯¼å‡º (`server/app/services/observability.py`)
- æ·»åŠ  OpenTelemetry åˆ†å¸ƒå¼è¿½è¸ª
- ç»“æ„åŒ–æ—¥å¿—å’Œæ€§èƒ½åˆ†æ

**ğŸ“¦ åŸºç¡€è®¾æ–½**
- æ–°å¢å…±äº«ç»„ä»¶æ¨¡å— (`common/`)
- æ–°å¢ gRPC åè®®å®šä¹‰ (`proto/inference.proto`)
- æ›´æ–°ä¾èµ– (`grpcio`, `redis`, `lz4`)

### v1.0.0

- åˆå§‹ç‰ˆæœ¬
- åŸºç¡€åˆ†å¸ƒå¼æ¶æ„
- Worker æ³¨å†Œä¸å¿ƒè·³
- æ™ºèƒ½ä»»åŠ¡è°ƒåº¦
- å®‰å…¨è®¤è¯æœºåˆ¶

## è´¡çŒ®

æ¬¢è¿æäº¤Issueå’ŒPull Request!
